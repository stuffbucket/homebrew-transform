name: 'Transform GoReleaser Formulas'
description: 'Fixes Homebrew formulas generated by GoReleaser by extracting method definitions to class level'
author: 'stuffbucket'

branding:
  icon: 'package'
  color: 'orange'

inputs:
  files:
    description: 'Space-separated list of formula files to transform (defaults to all Formula/*.rb)'
    required: false
    default: ''
  config:
    description: 'Path to transforms.yml config file'
    required: false
    default: ''
  ruby-version:
    description: 'Ruby version to use'
    required: false
    default: '3.3'

outputs:
  transformed:
    description: 'List of files that were transformed'
    value: ${{ steps.transform.outputs.transformed }}

runs:
  using: 'composite'
  steps:
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ inputs.ruby-version }}
        bundler: none

    - name: Install dependencies
      shell: bash
      run: gem install parser unparser rubocop

    - name: Transform formulas
      id: transform
      shell: bash
      env:
        ACTION_PATH: ${{ github.action_path }}
        INPUT_FILES: ${{ inputs.files }}
        INPUT_CONFIG: ${{ inputs.config }}
      run: |
        files="${INPUT_FILES:-Formula/*.rb}"
        config_arg=""
        if [ -n "$INPUT_CONFIG" ]; then
          config_arg="--config $INPUT_CONFIG"
        fi
        
        # Expand glob if needed
        expanded_files=""
        for pattern in $files; do
          for f in $pattern; do
            [ -f "$f" ] && expanded_files="$expanded_files $f"
          done
        done
        
        if [ -z "$expanded_files" ]; then
          echo "No formula files found"
          echo "transformed=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Run transformation
        ruby "$ACTION_PATH/scripts/transform-formula.rb" $config_arg $expanded_files
        
        # Fix style
        rubocop --autocorrect --only Style/BlockDelimiters $expanded_files 2>/dev/null || true
        
        echo "transformed=$expanded_files" >> $GITHUB_OUTPUT
